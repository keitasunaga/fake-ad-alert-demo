# 要件定義書 - FakeAdAlertDemo Phase 6: VCギャラリー サイドパネル

## 1. 概要

### 1.1 フェーズ目的

サイドパネルを「単一VC表示」から「マルチVCギャラリー」にリデザインし、デモサイト自体のVCと各バナー広告のVCを一覧・個別確認できるUIを提供する。競合のOriginator Profile（OP）が実装している「サイト＋広告バナーの信頼性表示」機能に対し、ストーリーバー型UIで差別化を図る。

### 1.2 背景・競合比較

| 項目 | Originator Profile (OP) | FakeAdAlertDemo (Phase 6) |
|------|------------------------|---------------------------|
| サイトの信頼性 | メディア発行者のOP情報を表示 | サイト自体のVCを表示 |
| 広告の信頼性 | 広告ごとのOP情報を表示 | 広告ごとのVCを表示 |
| UIパターン | 左カラムにアイコンリスト | ストーリーバー型（横スクロール） |
| 差別化 | - | グラスモーフィズム＋アニメーション、色分けリング |

### 1.3 スコープ

| 対象 | 内容 |
|------|------|
| 含む | サイドパネルUIリデザイン、サイトVC追加、マルチVC対応のデータモデル変更、Background Script変更 |
| 含まない | バナーオーバーレイ・バッジの変更、警告モーダルの変更、Content Scriptの検出ロジック変更、Instagram/TikTokへの影響 |

### 1.4 完了条件

- サイドパネルにストーリーバー（横スクロール型アイコン一覧）が表示される
- ストーリーバーにサイトVC（青リング）と検出された全バナー広告VC（緑=認証済み/赤=フェイク）が並ぶ
- アイコンをクリックすると該当VCの詳細情報が下部に表示される
- デモニュースサイトのVC情報（「デイリーニュース Japan」）が新たに表示される
- ストーリーバーは上部に固定（sticky）、詳細エリアは縦スクロール可能
- デモニュースサイトで5つのバナー（認証済み2 + フェイク3）すべてがストーリーバーに表示される
- 既存のInstagram/TikTok機能にデグレなし

### 1.5 前提条件

- Phase 0〜5が完了していること
- Chrome 114以上
- デモニュースサイトが稼働していること（Netlify or localhost）
- 既存のVCInfo型定義・モックVC情報を再利用

---

## 2. 機能要件

### 2.1 サイトVC

**[REQ-P6-001] デモサイト自体のVC情報追加**
- 「デイリーニュース Japan」のVC情報を新規作成する
- 既存の広告VCと同じ構造（`VCInfo`型）を使用する
- サイトVCの内容:
  - 発行者名: デイリーニュース Japan
  - DID: `did:web:daily-news-japan.example`
  - カテゴリ: ニュースメディア
  - 信頼チェーン: 総務省（信頼の基点）→ 日本新聞協会（認定メディア審査機関）→ デイリーニュース Japan（メディア発行者）
  - 検証ステータス: 全項目合格
  - ブロックチェーン証明: Sepoliaネットワーク

**[REQ-P6-002] サイトVCの自動検出**
- Content Script（news-site.ts）がページロード時にサイト自体の情報もBackground Scriptに通知する
- 新しいメッセージタイプ `SITE_DETECTED` を追加する:
  ```
  { type: 'SITE_DETECTED', siteName: 'デイリーニュース Japan', platform: 'news-site' }
  ```
- サイトVCは常に「認証済み」として扱う（デモ用）

### 2.2 マルチVC対応データモデル

**[REQ-P6-003] ストレージ構造の変更**
- 現状: `lastDetectedAd`（単一の`DetectedAdInfo`）
- 変更後: `detectedItems`（`DetectedItem[]` 配列）
- 新しい型定義:
  ```typescript
  interface DetectedItem {
    id: string;           // 一意のID（uuid or 連番）
    type: 'site' | 'ad';  // サイトVCか広告VCか
    advertiserName: string;
    platform: 'instagram' | 'tiktok' | 'news-site';
    result: 'verified' | 'fake' | 'unknown';
    matchedPattern?: string;
    listType?: string;
    detectedAt: string;
  }
  ```

**[REQ-P6-004] Background Scriptの変更**
- `AD_DETECTED` メッセージ受信時、既存のデータを上書きせず配列に追加する
- `SITE_DETECTED` メッセージ受信時、サイト情報を配列の先頭に追加する
- 同じ広告主名の重複は追加しない（既存エントリを更新）
- タブが変わった場合やページリロード時は配列をクリアする

### 2.3 ストーリーバーUI

**[REQ-P6-005] ストーリーバー基本仕様**
- サイドパネル上部にストーリーバー（横スクロール可能なアイコン一覧）を表示する
- 各アイコンは円形（直径48〜56px）で、色付きリングで囲む
- リングの色で状態を示す:
  - **青リング**: サイトVC（`type: 'site'`）
  - **緑リング**: 認証済み広告（`result: 'verified'`）
  - **赤リング**: フェイク広告（`result: 'fake'`）
- アイコン内には広告主名の頭文字（1〜2文字）を表示する
- アイコン下にラベル（広告主名の省略形、最大6文字）を表示する
- ストーリーバーは上部に固定（`position: sticky`）し、スクロールで隠れない

**[REQ-P6-006] ストーリーバーの並び順**
- 先頭: サイトVC（常に一番左）
- 2番目以降: 検出された広告を検出順に表示
- 認証済み・フェイクの区別なく、検出順で表示する

**[REQ-P6-007] ストーリーバーのインタラクション**
- アイコンをクリックすると、該当VCの詳細を下部の詳細エリアに表示する
- 選択中のアイコンはリングが太くなる（または光るエフェクト）
- 初期状態ではサイトVCが選択されている
- ストーリーバーは横スクロール可能（VC数が多い場合）
- スクロールバーは非表示にし、ドラッグまたはタッチスワイプでスクロールする

### 2.4 詳細エリア

**[REQ-P6-008] 認証済みVCの詳細表示**
- 既存の`renderVerifiedAd`と同等の4カードレイアウト:
  1. 広告情報カード（広告主名、DID、カテゴリ、プラットフォーム）
  2. 検証ステータスカード（5項目のチェック結果）
  3. 信頼チェーンカード（3階層のトラストチェーン）
  4. ブロックチェーン証明カード（Network、TxHash、Contract）
- 各カードは展開/折りたたみ可能（既存動作を維持）

**[REQ-P6-009] サイトVCの詳細表示**
- 認証済みVCと同様の4カードレイアウト
- ヘッダーの表示を変更:
  - アイコン: 🏢（サイト）/ ✅（広告）で区別
  - テキスト: 「サイト認証済み - このメディアは検証済みです」
- 信頼チェーンのrole表記:
  - root: 「信頼の基点」（総務省）
  - intermediate: 「認定メディア審査機関」（日本新聞協会）
  - subject: 「メディア発行者」（デイリーニュース Japan）

**[REQ-P6-010] フェイク広告の詳細表示**
- 既存の`renderFakeAd`と同等のダンジャーヘッダー＋詳細行レイアウト
- 変更なし（既存UIを再利用）

**[REQ-P6-011] 詳細エリアのスクロール**
- ストーリーバーの下に配置する詳細エリアは縦スクロール可能にする
- サイドパネル全体がスクロールし、ストーリーバーは常に上部に固定表示される

### 2.5 後方互換性

**[REQ-P6-012] Instagram/TikTok対応**
- Instagram/TikTokのContent Scriptからの`AD_DETECTED`メッセージは引き続き動作する
- SNSページではサイトVCは表示しない（`SITE_DETECTED`が送信されないため）
- SNSページで広告が1件のみ検出された場合、ストーリーバーに1アイコンのみ表示する
- ストーリーバーが1アイコンだけの場合でも正常に動作する

**[REQ-P6-013] 未検出時の表示**
- 何も検出されていない場合は、既存と同じ案内メッセージを表示する
- ストーリーバーは表示しない（検出が始まってから表示する）

---

## 3. 非機能要件

**[NFR-P6-001] パフォーマンス**
- ストーリーバーのレンダリングは16ms以内（60fps維持）
- 複数VC（最大10件程度）の表示でも動作がもたつかない
- ストーリーバーの横スクロールは滑らかに動作する

**[NFR-P6-002] デザイン品質**
- 既存のダークテーマ + グラスモーフィズムと統一
- ストーリーバーのアイコンはInstagram Stories風のモダンなデザイン
- 選択アニメーション（リング太さ変更、グロウエフェクト等）
- 色のコントラストはWCAGのAA基準を目安とする

**[NFR-P6-003] OP（Originator Profile）との差別化**
- OPの縦リスト型UIとは明確に異なるストーリーバー型UIを採用
- アニメーション・グラスモーフィズム等で「洗練された」印象を与える
- VCの情報量（ブロックチェーン証明等）でOPより詳細な情報を提供する

---

## 4. 制約事項

**[CON-P6-001] サイドパネル専用の変更**
- Phase 6の変更範囲はサイドパネル（`src/sidepanel/`）、Background Script（`src/background/`）、データモデル（`src/lib/`）に限定する
- Content Script（`src/content/`）への変更はメッセージ送信の追加のみ（`SITE_DETECTED`）
- バナーオーバーレイ（`src/components/warning-overlay.ts`）、認証バッジ（`src/components/verified-badge.ts`）は変更しない

**[CON-P6-002] 対象プラットフォーム**
- ストーリーバー + サイトVCの完全体験はデモニュースサイトのみ
- Instagram/TikTokではストーリーバーは表示されるが、サイトVCは含まない
- この差異は許容する（デモはニュースサイトで実施するため）

**[CON-P6-003] VCデータはモック**
- Phase 5同様、VCデータは全てモック（実際のVC検証は行わない）
- サイトVCも広告VCと同じ`VCInfo`型を使用する

---

## 5. UI仕様

### 5.1 サイドパネル全体レイアウト

```
┌─────────────────────────────┐
│  🛡️ FakeAdAlertDemo          │ ← ヘッダー（既存）
│  VC Ad Verifier              │
├─────────────────────────────┤
│  ✅ 拡張機能は有効            │ ← ステータス（既存）
│  📸 Instagram  🎵 TikTok     │
│  📰 News                     │
├─────────────────────────────┤
│                              │
│  ┌──┐ ┌──┐ ┌──┐ ┌──┐ ┌──┐  │ ← ストーリーバー（sticky）
│  │🔵│ │🟢│ │🟢│ │🔴│ │🔴│  │   横スクロール可能
│  │DN│ │Ty│ │Sn│ │投│ │偽│  │
│  └──┘ └──┘ └──┘ └──┘ └──┘  │
│  サイト Toyota Sony 投資  偽Sony│
│                              │
├ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┤
│                              │ ← 詳細エリア（スクロール可能）
│  ┌───────────────────────┐  │
│  │ 🏢 サイト認証済み        │  │
│  │ このメディアは検証済みです │  │
│  └───────────────────────┘  │
│                              │
│  📋 サイト情報    ▼          │  ← 展開可能カード
│  ┌───────────────────────┐  │
│  │ 発行者  デイリーニュース  │  │
│  │ DID     did:web:daily...  │  │
│  │ カテゴリ ニュースメディア  │  │
│  └───────────────────────┘  │
│                              │
│  ✓ 検証ステータス  ▼         │
│  🔗 信頼チェーン   ▼         │
│  ⛓️ ブロックチェーン証明 ▼   │
│                              │
├─────────────────────────────┤
│  ⚠️ これはデモ用アプリです     │ ← フッター（既存）
└─────────────────────────────┘
```

### 5.2 ストーリーバー詳細

```
┌─────────────────────────────────────────────┐
│                                              │
│   ┌────┐  ┌────┐  ┌────┐  ┌────┐  ┌────┐  │
│   │ 🔵 │  │ 🟢 │  │ 🟢 │  │ 🔴 │  │ 🔴 │  │
│   │ring│  │ring│  │ring│  │ring│  │ring│  │
│   │ DN │  │ Ty │  │ Sn │  │ 投資│  │ 偽S │  │
│   └────┘  └────┘  └────┘  └────┘  └────┘  │
│    サイト   Toyota  Sony   投資詐欺 偽ソニー │
│                                              │
│  ← スクロール可能 →                           │
└─────────────────────────────────────────────┘

選択中アイコン: リングが太い（3px → 4px）+ 外側グロウ
非選択アイコン: 通常リング（2px）、やや半透明
```

### 5.3 アイコンデザイン

| 要素 | 値 |
|------|-----|
| アイコンサイズ | 48px × 48px（リング含む） |
| 内側の円 | 40px、背景色 #1a1a2e |
| リング幅 | 非選択: 2px / 選択: 3px |
| テキスト | 頭文字1〜2文字、14px、bold |
| ラベル | 最大6文字、10px、下部 |
| 間隔 | アイコン間 12px |
| パディング | ストーリーバー左右 16px |

### 5.4 リングカラー

| 状態 | リング色 | 用途 |
|------|---------|------|
| サイトVC | `#3b82f6`（blue-500） | サイト自体のVC |
| 認証済み広告 | `#10b981`（emerald-500） | ホワイトリスト企業 |
| フェイク広告 | `#ef4444`（red-500） | ブラックリスト or 未認証 |
| 選択グロウ | 各色の40%透過 | 選択時のアウターグロウ |

### 5.5 選択アニメーション

- アイコンクリック時: リング幅が`2px → 3px`にトランジション（200ms ease-out）
- グロウエフェクト: `box-shadow: 0 0 8px {color}40`（200ms）
- 非選択化: 同アニメーションで逆方向（200ms）
- 詳細エリア切り替え: `opacity`トランジション（150ms）

### 5.6 カラースキーム

Phase 3〜5と同一。追加分のみ記載。

| 要素 | 色 | 用途 |
|------|-----|------|
| ストーリーバー背景 | `rgba(15, 15, 35, 0.8)` + `backdrop-filter: blur(8px)` | ストーリーバーエリア |
| ストーリーバー下線 | `rgba(255, 255, 255, 0.1)` | セクション区切り |
| アイコン内背景 | `#1a1a2e` | 円形アイコン内 |
| アイコンテキスト | `rgba(255, 255, 255, 0.9)` | 頭文字テキスト |
| ラベルテキスト | `rgba(255, 255, 255, 0.6)` | アイコン下ラベル |
| サイトヘッダー | `#3b82f6` → `#2563eb` グラデーション | サイトVC認証ヘッダー |

---

## 6. データフロー

### 6.1 現状のフロー（Phase 5）

```
Content Script (news-site.ts)
  ↓ AD_DETECTED (各バナーごと)
Background Script
  ↓ chrome.storage.session.set({ lastDetectedAd: adInfo })
  ↓ ※ 上書き（最後に検出された1件のみ保持）
Side Panel
  ↓ chrome.storage.onChanged → updateUI()
  ↓ 1件分のVC情報を表示
```

### 6.2 Phase 6のフロー

```
Content Script (news-site.ts)
  ↓ SITE_DETECTED (ページロード時に1回)
  ↓ AD_DETECTED (各バナーごと、複数回)
Background Script
  ↓ SITE_DETECTED → 配列先頭にサイト情報を追加
  ↓ AD_DETECTED → 配列末尾に広告情報を追加（重複排除）
  ↓ chrome.storage.session.set({ detectedItems: [...] })
Side Panel
  ↓ chrome.storage.onChanged → updateStoryBar() + updateDetail()
  ↓ ストーリーバー: 全アイテムのアイコンを表示
  ↓ 詳細エリア: 選択中アイテムのVC情報を表示
```

### 6.3 ストレージキー変更

| Phase | キー | 型 | 説明 |
|-------|-----|-----|------|
| Phase 5 | `lastDetectedAd` | `DetectedAdInfo` | 最後に検出された広告1件 |
| Phase 6 | `detectedItems` | `DetectedItem[]` | 全検出アイテム（サイト+広告） |
| Phase 6 | `selectedItemId` | `string` | 現在選択中のアイテムID（任意） |

---

## 7. サイトVC情報（モックデータ）

### 7.1 デイリーニュース Japan

```yaml
advertiserInfo:
  name: "デイリーニュース Japan"
  advertiserDid: "did:web:daily-news-japan.example"
  category: "ニュースメディア"
  platform: "news-site"

verificationStatus:
  issuerSignature: true
  expiration: true
  revocationStatus: true
  trustRegistry: true
  blockchain: true

trustChain:
  root:
    name: "総務省"
    role: "信頼の基点"
    did: "did:web:soumu.go.jp"
  intermediate:
    name: "日本新聞協会"
    role: "認定メディア審査機関"
    did: "did:web:pressnet.or.jp"
  subject:
    name: "デイリーニュース Japan"
    role: "メディア発行者"
    did: "did:web:daily-news-japan.example"

blockchainProof:
  network: "Sepolia"
  transactionHash: "0x4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e"
  contractAddress: "0xa67515e219ee1072e65A14b5A3439951b4b6d3D1"

vcId: "urn:uuid:daily-news-japan-site-001"
issuedAt: "2025-06-01T00:00:00Z"
expiresAt: "2026-06-01T00:00:00Z"
```

---

## 8. デモシナリオ

### 8.1 デモニュースサイトでの想定フロー

1. 営業担当がデモサイトを開く
2. 拡張機能が自動でサイトと5つのバナー広告を検出する
3. サイドパネルを開くと、ストーリーバーに6つのアイコンが表示される:
   - 🔵 デイリーニュース Japan（サイトVC）
   - 🟢 トヨタ自動車（認証済み）
   - 🟢 ソニー（認証済み）
   - 🔴 投資詐欺バナー（フェイク）
   - 🔴 なりすましバナー（フェイク）
   - 🔴 情報商材バナー（フェイク）
4. サイトVCアイコン（初期選択）の詳細が表示されている
5. トヨタアイコンをタップ → トヨタのVC詳細（DID、信頼チェーン、ブロックチェーン証明）に切り替わる
6. フェイクアイコンをタップ → 「フェイク広告の可能性」ヘッダー＋未認証情報が表示される
7. 「このように、VCに基づいてサイト・広告の信頼性が一覧できます」と説明

### 8.2 Instagram/TikTokでの動作

1. SNSフィードで広告が検出される
2. サイドパネルにストーリーバーが表示される（サイトVCなし、広告1件のみ）
3. 動作はPhase 5と同等（デグレなし）
